<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber-DApp 交互面板 V3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/index.umd.min.js"></script>
    <style>
        :root {
            --primary-blue: #00d4ff;
            --dark-bg: #0a0e17;
            --card-bg: #161b22;
            --text-main: #e6edf3;
            --accent-green: #2ecc71;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-main);
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-image: radial-gradient(circle at 50% 50%, #102a43 0%, #0a0e17 100%);
        }

        .dapp-container {
            width: 90%;
            max-width: 480px;
            background: var(--card-bg);
            border: 1px solid #30363d;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.15);
        }

        .header { text-align: center; margin-bottom: 25px; }
        .header h1 { color: var(--primary-blue); font-size: 24px; text-transform: uppercase; letter-spacing: 2px; margin: 0; }
        .version { font-size: 10px; color: #555; }

        .status-bar {
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid rgba(0, 212, 255, 0.2);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .balance-tag { color: var(--primary-blue); font-weight: bold; font-size: 20px; margin-top: 5px; }

        .btn {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
        }

        .btn-connect { background: linear-gradient(90deg, #00d4ff, #0055ff); color: white; box-shadow: 0 4px 15px rgba(0, 85, 255, 0.3); }
        .btn-action { background: #21262d; color: white; border: 1px solid #30363d; }
        .btn-action:hover { border-color: var(--primary-blue); box-shadow: 0 0 10px rgba(0, 212, 255, 0.2); }
        .btn-donate { background: var(--primary-blue); color: black; margin-top: 5px; }
        .btn-donate:hover { filter: brightness(1.1); transform: translateY(-1px); }

        .input-group { margin: 15px 0; text-align: left; }
        label { font-size: 12px; color: #8b949e; margin-left: 5px; }
        
        input {
            width: 100%;
            padding: 12px;
            box-sizing: border-box;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            color: white;
            margin-top: 5px;
            outline: none;
            font-size: 14px;
        }

        input:focus { border-color: var(--primary-blue); }

        .faucet-link {
            display: block;
            text-align: center;
            margin-top: 20px;
            color: #8b949e;
            text-decoration: none;
            font-size: 13px;
        }
        .faucet-link:hover { color: var(--primary-blue); }

        #logText { font-size: 12px; color: #8b949e; margin-top: 15px; text-align: center; min-height: 18px; }
    </style>
</head>
<body>

<div class="dapp-container">
    <div class="header">
        <h1>Cyber Portal</h1>
        <div class="version">V3.0 CUSTOM DONATION</div>
    </div>

    <div class="status-bar">
        <div id="addrDisplay" style="font-size: 13px;">钱包：未连接</div>
        <div id="balanceDisplay" class="balance-tag">0.0000 ETH</div>
        <div id="networkStatus" style="font-size: 11px; margin-top: 5px; color: #fa7a18;">⚠️ 请确保在 Arb Sepolia</div>
    </div>

    <button class="btn btn-connect" id="connectBtn" onclick="initWallet()">连接主流钱包</button>
    
    <div style="margin: 20px 0; height: 1px; background: #30363d;"></div>

    <div class="input-group">
        <label>合约互动 (Address: 0xAd07...)</label>
        <input type="text" id="msgInput" placeholder="输入你想留在链上的话...">
    </div>
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-action" onclick="callSetMessage()" style="flex: 2;">更新留言</button>
        <button class="btn btn-action" onclick="callGetMessage()" style="flex: 1;">查看</button>
    </div>

    <div style="margin: 20px 0; height: 1px; background: #30363d;"></div>

    <div class="input-group">
        <label>打赏 ETH 到开发者钱包</label>
        <input type="number" id="donateAmount" step="0.001" value="0.001" placeholder="输入打赏金额 (ETH)">
    </div>
    <button class="btn btn-donate" onclick="donateEth()">立即打赏</button>

    <a href="https://www.alchemy.com/faucets/arbitrum-sepolia" target="_blank" class="faucet-link">⛽ 缺少测试币？点击前往领水站</a>
    
    <div id="logText">系统就绪</div>
</div>

<script>
    const CONTRACT_ADDR = "0xAd074eF8dFa3c625a53185450F24203bC35160F6";
    const DONATE_ADDR = "0x2d2f8716607d77d3389af77e0f47e559b8b6c36a";
    const ARB_SEPOLIA_ID = 421614n;

    const ABI = [
        "function message() public view returns (string)",
        "function setMessage(string memory _newMsg) public"
    ];

    let provider, signer, contract;

    async function initWallet() {
        const uiLog = document.getElementById('logText');
        const injectedProvider = window.okxwallet || window.ethereum;

        if (!injectedProvider) {
            alert("未检测到钱包！");
            return;
        }

        try {
            uiLog.innerText = "唤起钱包中...";
            const accounts = await injectedProvider.request({ method: 'eth_requestAccounts' });
            
            provider = new ethers.BrowserProvider(injectedProvider);
            signer = await provider.getSigner();
            
            const network = await provider.getNetwork();
            if (network.chainId !== ARB_SEPOLIA_ID) {
                uiLog.innerText = "网络错误！正在请求切换...";
                try {
                    await injectedProvider.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x66eee' }],
                    });
                } catch (e) { alert("请手动切换至 Arbitrum Sepolia"); return; }
            }

            contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);
            
            const address = accounts[0];
            document.getElementById('addrDisplay').innerText = `已连接: ${address.substring(0,6)}...${address.substring(38)}`;
            document.getElementById('networkStatus').innerText = "✅ 已接入 Arbitrum Sepolia";
            document.getElementById('networkStatus').style.color = "#2ecc71";
            document.getElementById('connectBtn').innerText = "已成功连接";
            
            updateBalance(address);
            uiLog.innerText = "Ready to Sync";
        } catch (err) {
            console.error(err);
            uiLog.innerText = "连接被中断";
        }
    }

    async function updateBalance(address) {
        const balance = await provider.getBalance(address);
        document.getElementById('balanceDisplay').innerText = `${parseFloat(ethers.formatEther(balance)).toFixed(4)} ETH`;
    }

    async function callGetMessage() {
        if (!contract) return alert("请先连接钱包");
        try {
            const msg = await contract.message();
            alert("链上最新内容: " + msg);
        } catch (e) { console.error(e); }
    }

    async function callSetMessage() {
        if (!contract) return alert("请先连接钱包");
        const val = document.getElementById('msgInput').value;
        if (!val) return alert("内容不能为空");
        
        try {
            document.getElementById('logText').innerText = "等待区块确认...";
            const tx = await contract.setMessage(val);
            await tx.wait();
            document.getElementById('logText').innerText = "上链成功！";
            alert("留言已更新");
        } catch (e) { 
            document.getElementById('logText').innerText = "交易已取消";
        }
    }

    async function donateEth() {
        if (!signer) return alert("请先连接钱包");
        const amount = document.getElementById('donateAmount').value;
        
        if (!amount || amount <= 0) return alert("请输入有效的打赏金额");

        try {
            document.getElementById('logText').innerText = `正在发起 ${amount} ETH 的转账...`;
            const tx = await signer.sendTransaction({
                to: DONATE_ADDR,
                value: ethers.parseEther(amount.toString())
            });
            
            document.getElementById('logText').innerText = "转账确认中...";
            await tx.wait();
            
            alert("感谢您的支持！");
            document.getElementById('logText').innerText = "打赏成功！感谢支持。";
            updateBalance(await signer.getAddress()); // 更新余额显示
        } catch (e) {
            console.error(e);
            document.getElementById('logText').innerText = "打赏已取消";
        }
    }
</script>

</body>
</html>
