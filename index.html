<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKX 钱包交互测试</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/index.umd.min.js"></script>
    <style>
        body { font-family: 'PingFang SC', sans-serif; background: #1a1a1a; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: #262626; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 100%; max-width: 400px; text-align: center; border: 1px solid #333; }
        h2 { margin-bottom: 30px; color: #fff; }
        .status { padding: 8px 15px; border-radius: 50px; font-size: 13px; margin-bottom: 25px; display: inline-block; background: #3d3d3d; color: #aaa; }
        .status.connected { background: #1d392a; color: #2ecc71; border: 1px solid #2ecc71; }
        button { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-connect { background: #fff; color: #000; }
        .btn-connect:hover { background: #ccc; }
        .btn-action { background: #3d3d3d; color: #fff; border: 1px solid #555; }
        .btn-action:hover { background: #4d4d4d; }
        input { width: calc(100% - 30px); padding: 15px; background: #1a1a1a; border: 1px solid #333; border-radius: 10px; color: white; margin: 15px 0; text-align: center; }
        #msgBox { margin-top: 20px; padding: 15px; background: #1a1a1a; border-radius: 10px; color: #2ecc71; min-height: 20px; border: 1px dashed #333; }
    </style>
</head>
<body>

<div class="card">
    <h2>OKX 交互面板</h2>
    <div id="statusLabel" class="status">钱包未连接</div>
    
    <button class="btn-connect" onclick="connectOKX()">连接 OKX 钱包</button>
    
    <div style="margin: 20px 0; border-top: 1px solid #333;"></div>
    
    <button class="btn-action" onclick="readContract()">读取链上消息</button>
    <div id="msgBox">内容将显示在这里</div>

    <input type="text" id="inputField" placeholder="输入新的留言内容...">
    <button class="btn-action" style="background: #2ecc71; color: #000; border: none;" onclick="writeContract()">更新留言</button>
    
    <p id="txInfo" style="font-size: 11px; color: #666; margin-top: 15px;"></p>
</div>

<script>
    // 你的配置
    const CONTRACT_ADDRESS = "0xAd074eF8dFa3c625a53185450F24203bC35160F6";
    const ABI = [
        "function message() public view returns (string)",
        "function setMessage(string memory _newMsg) public"
    ];

    let provider;
    let signer;
    let contract;

    // 核心函数：专门连接 OKX
    async function connectOKX() {
        // 强制寻找 OKX 注入的对象
        const okx = window.okxwallet;

        if (!okx) {
            alert("错误：未检测到 OKX 钱包！\n请检查：\n1. 是否安装了 OKX 插件\n2. 扩展设置里是否勾选了‘允许在无痕模式下运行’");
            return;
        }

        try {
            // 请求授权
            const accounts = await okx.request({ method: 'eth_requestAccounts' });
            
            // 使用 Ethers.js 包装 OKX 对象
            provider = new ethers.BrowserProvider(okx);
            signer = await provider.getSigner();
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

            // 更新 UI
            const addr = accounts[0];
            const label = document.getElementById('statusLabel');
            label.innerText = "已连接: " + addr.substring(0,6) + "..." + addr.substring(38);
            label.className = "status connected";
            console.log("OKX Connected:", addr);
        } catch (err) {
            console.error(err);
            alert("连接被拒绝或出错");
        }
    }

    // 读取合约里的 message 变量
    async function readContract() {
        if (!contract) return alert("请先连接钱包");
        try {
            const result = await contract.message();
            document.getElementById('msgBox').innerText = result;
        } catch (err) {
            alert("读取失败，请检查是否在 Arbitrum Sepolia 网络");
        }
    }

    // 调用 setMessage 函数
    async function writeContract() {
        if (!contract) return alert("请先连接钱包");
        const val = document.getElementById('inputField').value;
        if (!val) return alert("请输入内容");

        try {
            document.getElementById('txInfo').innerText = "请在 OKX 钱包弹窗中确认...";
            const tx = await contract.setMessage(val);
            
            document.getElementById('txInfo').innerText = "交易已提交，等待上链...";
            await tx.wait(); // 等待交易打包
            
            document.getElementById('txInfo').innerText = "更新成功！";
            readContract(); // 刷新显示
        } catch (err) {
            console.error(err);
            document.getElementById('txInfo').innerText = "交易失败。";
        }
    }
</script>

</body>
</html>
