<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber-DApp 交互面板 V3.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/index.umd.min.js"></script>
    <style>
        :root {
            --primary-blue: #00d4ff;
            --dark-bg: #0a0e17;
            --card-bg: #161b22;
            --text-main: #e6edf3;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-main);
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-image: radial-gradient(circle at 50% 50%, #102a43 0%, #0a0e17 100%);
        }

        .dapp-container {
            width: 90%;
            max-width: 480px;
            background: var(--card-bg);
            border: 1px solid #30363d;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.15);
        }

        .header { text-align: center; margin-bottom: 25px; }
        .header h1 { color: var(--primary-blue); font-size: 24px; text-transform: uppercase; letter-spacing: 2px; margin: 0; }

        .status-bar {
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid rgba(0, 212, 255, 0.2);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .balance-tag { color: var(--primary-blue); font-weight: bold; font-size: 20px; margin-top: 5px; }

        .btn {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
        }

        .btn-connect { background: linear-gradient(90deg, #00d4ff, #0055ff); color: white; box-shadow: 0 4px 15px rgba(0, 85, 255, 0.3); }
        .btn-action { background: #21262d; color: white; border: 1px solid #30363d; }
        .btn-action:hover { border-color: var(--primary-blue); }
        .btn-donate { background: var(--primary-blue); color: black; }

        input {
            width: 100%;
            padding: 12px;
            box-sizing: border-box;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            color: white;
            margin-top: 5px;
            outline: none;
        }

        .faucet-link {
            display: block;
            text-align: center;
            margin-top: 20px;
            color: #8b949e;
            text-decoration: none;
            font-size: 13px;
        }

        #logText { font-size: 12px; color: var(--primary-blue); margin-top: 15px; text-align: center; min-height: 18px; }
    </style>
</head>
<body>

<div class="dapp-container">
    <div class="header">
        <h1>Cyber Portal</h1>
    </div>

    <div class="status-bar">
        <div id="addrDisplay" style="font-size: 13px;">钱包：未连接</div>
        <div id="balanceDisplay" class="balance-tag">0.0000 ETH</div>
        <div id="networkStatus" style="font-size: 11px; margin-top: 5px; color: #fa7a18;">⚠️ 网络检测中...</div>
    </div>

    <button class="btn btn-connect" id="connectBtn" onclick="initWallet()">链接钱包</button>
    
    <div style="margin: 20px 0; height: 1px; background: #30363d;"></div>

    <div style="text-align:left; font-size:12px; color:#8b949e; margin-bottom:5px;">合约留言互动</div>
    <input type="text" id="msgInput" placeholder="输入内容...">
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-action" onclick="callSetMessage()" style="flex: 2;">更新留言</button>
        <button class="btn btn-action" onclick="callGetMessage()" style="flex: 1;">查看</button>
    </div>

    <div style="margin: 20px 0; height: 1px; background: #30363d;"></div>

    <div style="text-align:left; font-size:12px; color:#8b949e; margin-bottom:5px;">自定义打赏 (ETH)</div>
    <input type="number" id="donateAmount" step="0.001" value="0.001">
    <button class="btn btn-donate" onclick="donateEth()">立即打赏给作者</button>

    <a href="https://www.alchemy.com/faucets/arbitrum-sepolia" target="_blank" class="faucet-link">⛽ 点击前往领水站 (Alchemy)</a>
    
    <div id="logText">等待连接...</div>
</div>

<script>
    const CONTRACT_ADDR = "0xAd074eF8dFa3c625a53185450F24203bC35160F6";
    const DONATE_ADDR = "0x2d2f8716607d77d3389af77e0f47e559b8b6c36a";
    const ARB_SEPOLIA_ID = 421614n;

    const ABI = [
        "function message() public view returns (string)",
        "function setMessage(string memory _newMsg) public"
    ];

    let provider, signer, contract;

    async function initWallet() {
        const uiLog = document.getElementById('logText');
        const external = window.okxwallet || window.ethereum;

        if (!external) {
            alert("未检测到钱包插件！");
            return;
        }

        try {
            uiLog.innerText = "正在请求钱包授权...";
            await external.request({ method: 'eth_requestAccounts' });
            
            provider = new ethers.BrowserProvider(external);
            signer = await provider.getSigner();
            
            const network = await provider.getNetwork();
            if (network.chainId !== ARB_SEPOLIA_ID) {
                uiLog.innerText = "请在钱包中切换到 Arb Sepolia";
                try {
                    await external.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x66eee' }],
                    });
                } catch (e) { alert("网络错误：请在钱包内手动切换到 Arbitrum Sepolia"); return; }
            }

            contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);
            const address = await signer.getAddress();
            
            document.getElementById('addrDisplay').innerText = `已连接: ${address.substring(0,6)}...${address.substring(38)}`;
            document.getElementById('networkStatus').innerText = "✅ 已接入 Arbitrum Sepolia";
            document.getElementById('networkStatus').style.color = "#2ecc71";
            document.getElementById('connectBtn').innerText = "钱包已绑定";
            
            const balance = await provider.getBalance(address);
            document.getElementById('balanceDisplay').innerText = `${parseFloat(ethers.formatEther(balance)).toFixed(4)} ETH`;
            uiLog.innerText = "交互系统就绪";
        } catch (err) {
            uiLog.innerText = "连接被取消";
            console.error(err);
        }
    }

    async function callGetMessage() {
        if (!contract) return alert("请先链接钱包");
        try {
            const msg = await contract.message();
            alert("链上数据内容: " + msg);
        } catch (e) { alert("读取失败"); }
    }

    async function callSetMessage() {
        if (!contract) return alert("请先链接钱包");
        const val = document.getElementById('msgInput').value;
        if (!val) return alert("内容不能为空");
        
        try {
            document.getElementById('logText').innerText = "正在唤起签名确认窗口...";
            // 增加手动 GasLimit 确保弹窗弹出
            const tx = await contract.setMessage(val, {
                gasLimit: 120000
            });
            document.getElementById('logText').innerText = "交易打包中，请稍候...";
            await tx.wait();
            document.getElementById('logText').innerText = "更新成功！";
            alert("上链成功！");
        } catch (e) { 
            document.getElementById('logText').innerText = "签名取消或失败";
            console.error(e);
        }
    }

    async function donateEth() {
        if (!signer) return alert("请先链接钱包");
        const amount = document.getElementById('donateAmount').value;
        if (!amount || amount <= 0) return alert("金额无效");

        try {
            document.getElementById('logText').innerText = "准备发起转账签名...";
            const tx = await signer.sendTransaction({
                to: DONATE_ADDR,
                value: ethers.parseEther(amount.toString()),
                gasLimit: 50000
            });
            document.getElementById('logText').innerText = "转账中...";
            await tx.wait();
            alert("打赏成功，感谢支持！");
            document.getElementById('logText').innerText = "打赏已完成";
        } catch (e) {
            document.getElementById('logText').innerText = "转账已取消";
        }
    }
</script>

</body>
</html>
